# Geminiエージェント 開発ルール (GEMINI_AGENT_RULES.md)

## 1. 基本原則 (Core Principles)

1.  **ルール遵守**: `PROJECT_RULES.md`に記載されているすべてのルールを最優先で遵守します。
2.  **指示の理解と確認**: ユーザーの指示を正確に理解し、安全かつ効率的にタスクを遂行します。指示内容に不明瞭な点や矛盾がある場合、またはメッセージが不自然な終わり方をしている場合は、実行に移る前に必ずユーザーに確認を求めます。
3.  **安全性**: ファイルの変更、コマンドの実行、特にインフラやセキュリティに関わる操作については、その影響を説明し、ユーザーの承認を得てから実行します。
4.  **自律性と透明性**: 定義されたルールに基づき自律的にタスクを進めますが、その実行プロセス、判断基準、結果は常にユーザーに対して透明性を保ちます。
5.  **共有リソースの尊重**: **MCPサーバーやその設定ファイル（`mcp.json`など）を含む、他のシステムやユーザーと共有される可能性のあるリソースは、私の直接的な利用範囲外であっても、ユーザーからの明確な指示と、その変更が環境全体に与える影響を十分に理解するまで、削除、変更、または停止を試みてはなりません。私のツールセットで直接操作できないことが、そのリソースが不要であるという判断の根拠にはなりません。**

## 2. 開発ワークフロー (Development Workflow)

1.  **Issue駆動開発の徹底**:
    *   全ての作業はGitHub Issueを起点とします。ユーザーから直接作業指示があった場合でも、まず関連するIssueを作成・確認することを提案します。（例: `./scripts/create-issue.sh`の利用提案）
2.  **ブランチ戦略の遵守**:
    *   `PROJECT_RULES.md`で定義されたブランチ命名規則（`feature/issue-{番号}-{機能名}`など）に厳密に従います。
3.  **TDDの実践**:
    *   新しい機能の実装や修正を行う際には、まずテストコードを作成または更新し、テストが失敗することを確認してから実装に取り掛かります。テストカバレッジ80%以上を維持します。
4.  **Pull Request (PR) の品質**:
    *   PRは「最小実装単位」かつ「単一責任の原則」を遵守します（200行未満推奨）。
    *   PR作成時は、テンプレートに従い、変更内容、テスト項目、ドキュメント更新の有無を明記します。
    *   マージ前には、CI/CDのチェック (`gh pr checks`) がすべて成功していることを確認します。

## 3. ファイルとドキュメントの管理 (File & Document Management)

1.  **ファイル操作の原則**:
    *   `PROJECT_RULES.md`の「ファイル管理原則」に従い、適切なディレクトリ配置と命名規則を遵守します。
    *   操作前には必ず対象ファイルを`read_file`で読み込み、現状を把握した上で、影響範囲を最小限に抑える方法（`replace`など）を選択します。
2.  **ドキュメントの同期**:
    *   ソースコードの変更が、既存のドキュメント（`README.md`, `ARCHITECTURE.md`, `API_SPEC.md`など）に影響を与える場合、必ず関連ドキュメントの更新も合わせて行います。
    *   システム構成やシーケンスに変更があった場合は、`docs/plantuml/`配下のPlantUMLファイルを更新します。
3.  **報告と記録**:
    *   `PROJECT_RULES.md`に定められたタイミングで、指定のフォーマットを用いて「作業報告書」を作成・提出します。
    *   発生したエラーやその解決策は、再現可能な形で「トラブル事例集」に記録し、ナレッジとして蓄積します。
    *   対話の重要な決定事項は`./scripts/chat-log-manager.sh`を用いて記録します。

## 4. ツールと環境の利用 (Tool & Environment Usage)

1.  **スクリプトの積極活用**:
    *   `scripts/`ディレクトリに用意されたヘルパースクリプト（`create-issue.sh`, `create-pr.sh`, `check-workflow.sh`など）を積極的に利用し、作業の標準化と効率化を図ります。
2.  **MCPサーバーの適切な利用**:
    *   `PROJECT_RULES.md`の定義に基づき、Docker、GitHub、TerraformなどのMCPサーバーを適切に使い分けます。
    *   MCPの機能制限を考慮し、必要に応じて軽量設定の利用や、Playwrightの直接実行などの代替案を提案します。
3.  **品質保証**:
    *   `pytest`によるバックエンドテスト、`Playwright`によるE2Eテストを適宜実行し、成果物の品質を担保します。
    *   コード提出前には、リンターやフォーマッターを適用し、Googleコーディング規約を遵守します。

## 5. コミュニケーションと承認 (Communication & Approval)

1.  **最終確認プロセス**:
    *   重要な成果物の完成時やPRのマージ前には、`PROJECT_RULES.md`に定められた最終確認・承認プロセス（担当者への確認依頼など）を遵守します。
2.  **提案**:
    *   常にプロジェクトルールに基づいた最善策を考え、ユーザーに提案します。ルールにない事項については、複数の選択肢とそのメリット・デメリットを提示し、ユーザーの判断を仰ぎます。

## 6. バックアップと復旧 (Backup & Recovery)

1.  **作業開始前のバックアップ**:
    *   **全ての作業に入る前に、プロジェクトルートディレクトリ (`/home/nanashi7777/happyquest`) の圧縮バックアップを `/home/nanashi7777/bkup` フォルダに作成します。**
    *   バックアップファイル名は `happyquest_backup_YYYYMMDD_HHMMSS.tar.gz` とし、`node_modules`、`venv`、`google-cloud-sdk`、および既存の`.tar.gz`ファイルは除外します。
2.  **WSL2環境のバックアップ**:
    *   **大きな変更（例: OSレベルの設定変更、主要なフレームワークのバージョンアップなど）を行う際は、ユーザーがWSL2のUbuntu 24.04環境全体のバックアップを取得していることを前提とします。**
    *   **重大なトラブルが発生した場合、ユーザーはWSL2環境全体のバックアップから復旧を行うことを想定しています。**