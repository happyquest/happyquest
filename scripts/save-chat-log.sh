#!/bin/bash

# チャットログ保存支援スクリプト
# 手動でのチャットログ保存を支援

set -e

CHAT_DIR="chat-logs"
mkdir -p "$CHAT_DIR"

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
CHAT_FILE="$CHAT_DIR/chat-session-$TIMESTAMP.md"

echo "💬 チャットログ保存スクリプト"
echo "=============================="
echo "📅 実行日時: $(date)"
echo "📁 保存先: $CHAT_FILE"
echo

# 引数チェック
if [ $# -eq 0 ]; then
    echo "使用方法: $0 \"セッション概要\""
    echo "例: $0 \"エラー予防システム実装\""
    exit 1
fi

SESSION_SUMMARY="$1"

# テンプレート作成
cat > "$CHAT_FILE" << EOF
# チャットセッションログ

**セッション開始**: $(date)  
**作業者**: $(whoami)  
**ブランチ**: $(git branch --show-current 2>/dev/null || echo "不明")  
**プロジェクト**: HappyQuest  
**セッション概要**: $SESSION_SUMMARY

## 📋 セッション概要

### 主な作業内容
- [ ] [作業内容1]
- [ ] [作業内容2]
- [ ] [作業内容3]

### 重要な決定事項
1. **技術選択**: [決定内容]
2. **設計方針**: [決定内容]
3. **実装方針**: [決定内容]

### 発生した問題と解決策
1. **問題**: [問題内容]
   **解決策**: [解決方法]
   
2. **問題**: [問題内容]
   **解決策**: [解決方法]

## 💡 重要な学習・発見

### 技術的発見
- [発見内容1]
- [発見内容2]

### プロセス改善
- [改善点1]
- [改善点2]

## 🔗 関連リソース

### 作成・変更されたファイル
EOF

# 最近変更されたファイルを自動取得
if git rev-parse --git-dir > /dev/null 2>&1; then
    echo "$(git diff --name-only HEAD~3..HEAD 2>/dev/null | head -10)" | while read -r file; do
        if [ -n "$file" ]; then
            echo "- $file: [変更内容を記載]" >> "$CHAT_FILE"
        fi
    done
else
    echo "- [ファイル名1]: [変更内容]" >> "$CHAT_FILE"
    echo "- [ファイル名2]: [変更内容]" >> "$CHAT_FILE"
fi

cat >> "$CHAT_FILE" << EOF

### 参考にしたドキュメント・リンク
- [リンク1]: [説明]
- [リンク2]: [説明]

## 📊 成果物

### 完了した作業
- ✅ [完了した作業1]
- ✅ [完了した作業2]
- ⏸️ [部分完了した作業3]

### 次回への引き継ぎ事項
- [ ] [引き継ぎ事項1]
- [ ] [引き継ぎ事項2]

## 🎯 次のアクション

### 即座に必要なアクション
- [ ] [アクション1] - 期限: [日時]
- [ ] [アクション2] - 期限: [日時]

### 将来的なアクション
- [ ] [アクション1] - 期限: [日時]
- [ ] [アクション2] - 期限: [日時]

---

**ログ作成日時**: $(date)  
**次回セッション予定**: [日時]

## 📝 実際のチャットログ

<!-- ここに手動でチャットの重要な部分をコピー&ペーストしてください -->

### 重要な質問と回答

**Q**: [質問内容]
**A**: [回答内容]

**Q**: [質問内容]
**A**: [回答内容]

### 実行したコマンド

\`\`\`bash
# 実行したコマンドをここに記録
EOF

# 最近実行されたコマンドの履歴を取得（可能な場合）
if [ -f ~/.bash_history ]; then
    echo "# 最近のコマンド履歴（参考）" >> "$CHAT_FILE"
    tail -20 ~/.bash_history | grep -E "(git|npm|node|./scripts)" | tail -10 >> "$CHAT_FILE"
fi

cat >> "$CHAT_FILE" << EOF
\`\`\`

### 生成されたコード

\`\`\`javascript
// 重要なコード片をここに記録
\`\`\`

### セッション中のエラーと解決

**エラー**: [エラー内容]
**解決方法**: [解決手順]

**エラー**: [エラー内容]
**解決方法**: [解決手順]

## 📈 メトリクス

### 作業効率
- **予定時間**: [X時間]
- **実際時間**: [X時間]
- **効率**: [予定/実際 * 100]%

### 品質
- **エラー発生数**: [X件]
- **解決済み**: [X件]
- **未解決**: [X件]

### 学習
- **新しい技術**: [技術名]
- **改善したプロセス**: [プロセス名]
- **次回活用予定**: [内容]

EOF

echo "✅ チャットログテンプレート作成完了"
echo "📝 手動でチャット内容を追記してください: $CHAT_FILE"
echo
echo "💡 使用方法:"
echo "   1. 重要な質問・回答をコピー&ペースト"
echo "   2. 実行したコマンドを記録"
echo "   3. 生成されたコードを保存"
echo "   4. 学習・発見事項を記録"
echo "   5. エラーと解決方法を記録"
echo
echo "🔧 次のステップ:"
echo "   1. エディタでファイルを開く: code $CHAT_FILE"
echo "   2. チャット内容を手動で追記"
echo "   3. Gitにコミット: git add $CHAT_FILE && git commit -m \"チャットログ保存: $SESSION_SUMMARY\""