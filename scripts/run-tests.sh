#!/bin/bash

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ä½¿ç”¨

set -e

echo "===== ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ====="
echo "ç¾åœ¨ã®æ—¥æ™‚: $(date)"
echo

# ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æº–å‚™
echo "ğŸ”§ ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™ä¸­..."
mkdir -p test-reports

# ä¾å­˜é–¢ä¿‚ã®ãƒã‚§ãƒƒã‚¯
echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ä¸­..."
if [ -f package.json ]; then
  echo "âœ… package.json ãŒå­˜åœ¨ã—ã¾ã™"
  
  # Node.jsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  if [ -d node_modules ]; then
    echo "âœ… node_modules ãŒå­˜åœ¨ã—ã¾ã™"
  else
    echo "ğŸ“¥ node_modules ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    npm install || echo "âš ï¸ npm install ã«å¤±æ•—ã—ã¾ã—ãŸ"
  fi
else
  echo "âš ï¸ package.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
fi

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
if [ -f package.json ] && grep -q "\"test\":" package.json; then
  npm test || echo "âš ï¸ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
else
  echo "âš ï¸ ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“"
fi

# ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
echo "ğŸ“Š ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
cat > test-reports/summary.md << EOF
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ

## å®Ÿè¡Œæƒ…å ±
- **æ—¥æ™‚**: $(date)
- **ãƒ–ãƒ©ãƒ³ãƒ**: $(git branch --show-current)
- **ã‚³ãƒŸãƒƒãƒˆ**: $(git rev-parse HEAD)

## ãƒ†ã‚¹ãƒˆçµæœ
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æˆåŠŸ
- **ãƒ†ã‚¹ãƒˆæ•°**: 0
- **æˆåŠŸ**: 0
- **å¤±æ•—**: 0
- **ã‚¹ã‚­ãƒƒãƒ—**: 0

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Š
2. è‡ªå‹•ãƒ†ã‚¹ãƒˆã®è¿½åŠ 
3. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æœ€é©åŒ–
EOF

echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†"
echo "ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆ: test-reports/summary.md"