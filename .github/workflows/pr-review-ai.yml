name: ğŸ¤– AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    name: AI Code Review
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r requirements.txt || echo "requirements.txt not found"
          pip install -r requirements-dev.txt || echo "requirements-dev.txt not found"
          pip install flake8 mypy bandit safety pytest pytest-cov
          
      - name: ğŸ” Static Analysis
        id: static-analysis
        run: |
          echo "ğŸ” Running static analysis..."
          
          # Pythoné™çš„è§£æ
          flake8 src/ --output-file=flake8-report.txt --exit-zero || echo "No src/ directory"
          mypy src/ --txt-report mypy-report --exit-zero || echo "No src/ directory"
          bandit -r src/ -f json -o bandit-report.json --exit-zero || echo "No src/ directory"
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          safety check --json --output safety-report.json --exit-zero || echo "Safety check completed"
          
          echo "static_analysis_complete=true" >> $GITHUB_OUTPUT
          
      - name: ğŸ§ª Run Tests
        id: tests
        run: |
          echo "ğŸ§ª Running tests with coverage..."
          
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
          if [ -d "src/" ] && [ -d "tests/" ]; then
            pytest --cov=src --cov-report=json --cov-report=html --junitxml=pytest-report.xml || echo "Tests completed with issues"
            
            # ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
            if [ -f "coverage.json" ]; then
              COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])" 2>/dev/null || echo "0")
            else
              COVERAGE="0"
            fi
          else
            echo "No tests directory found"
            COVERAGE="0"
          fi
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "tests_complete=true" >> $GITHUB_OUTPUT
          
      - name: ğŸ“Š Quality Score Calculation
        id: quality-score
        run: |
          cat > quality_calculator.py << 'EOF'
          import json
          import os
          
          def calculate_quality_score():
              # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¹ã‚³ã‚¢ (30%)
              coverage = float(os.getenv('COVERAGE', '0'))
              if coverage >= 80:
                  coverage_score = 30
              elif coverage >= 60:
                  coverage_score = 20
              elif coverage >= 40:
                  coverage_score = 10
              else:
                  coverage_score = 0
              
              # é™çš„è§£æã‚¹ã‚³ã‚¢ (25%)
              static_score = 25  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæº€ç‚¹
              
              # Flake8ãƒã‚§ãƒƒã‚¯
              try:
                  with open('flake8-report.txt', 'r') as f:
                      flake8_issues = len(f.readlines())
                      if flake8_issues > 10:
                          static_score -= 10
                      elif flake8_issues > 5:
                          static_score -= 5
              except:
                  pass
              
              # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢ (25%)
              security_score = 25  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæº€ç‚¹
              
              try:
                  with open('bandit-report.json', 'r') as f:
                      bandit_data = json.load(f)
                      high_severity = len([r for r in bandit_data.get('results', []) if r.get('issue_severity') == 'HIGH'])
                      medium_severity = len([r for r in bandit_data.get('results', []) if r.get('issue_severity') == 'MEDIUM'])
                      
                      security_score -= (high_severity * 10 + medium_severity * 5)
                      security_score = max(0, security_score)
              except:
                  pass
              
              # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¹ã‚³ã‚¢ (20%)
              performance_score = 20  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæº€ç‚¹
              
              total_score = coverage_score + static_score + security_score + performance_score
              return min(100, max(0, total_score))
          
          quality_score = calculate_quality_score()
          print(f"Quality Score: {quality_score}")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"quality_score={quality_score}\n")
          EOF
          
          python quality_calculator.py
          
      - name: ğŸ“ Generate Review Comment
        id: review-comment
        env:
          QUALITY_SCORE: ${{ steps.quality-score.outputs.quality_score }}
          COVERAGE: ${{ steps.tests.outputs.coverage }}
        run: |
          python -c "
          import os
          
          quality_score = int(os.getenv('QUALITY_SCORE', '0'))
          coverage = float(os.getenv('COVERAGE', '0'))
          
          if quality_score >= 90:
              status = 'AI Code Review - å„ªç§€'
              emoji = 'ğŸ‰'
          elif quality_score >= 80:
              status = 'AI Code Review - åˆæ ¼'
              emoji = 'ğŸ‘'
          elif quality_score >= 70:
              status = 'AI Code Review - è¦æ”¹å–„'
              emoji = 'âš ï¸'
          else:
              status = 'AI Code Review - è¦ä¿®æ­£'
              emoji = 'âŒ'
          
          comment_parts = [
              f'## {emoji} {status}',
              '',
              f'### ğŸ“Š å“è³ªã‚¹ã‚³ã‚¢: {quality_score}/100',
              '',
              '### ğŸ“ˆ ãƒ¡ãƒˆãƒªã‚¯ã‚¹',
              f'- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: {coverage:.1f}%',
              '- **é™çš„è§£æ**: å®Ÿè¡Œæ¸ˆã¿',
              '- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³**: å®Ÿè¡Œæ¸ˆã¿',
              '',
              f'### {emoji} è©•ä¾¡çµæœ'
          ]
          
          if quality_score >= 90:
              comment_parts.extend([
                  '',
                  '### âœ¨ å„ªç§€ãªå“è³ªã§ã™ï¼',
                  '- ã‚³ãƒ¼ãƒ‰å“è³ªãŒéå¸¸ã«é«˜ã„ãƒ¬ãƒ™ãƒ«ã«é”ã—ã¦ã„ã¾ã™',
                  '- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒååˆ†ã§ã™',
                  '- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æº–æ‹ ã—ã¦ã„ã¾ã™',
                  '- å³åº§ã«ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™',
                  '',
                  '### ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',
                  'ã“ã®PRã¯å“è³ªåŸºæº–ã‚’å¤§å¹…ã«ä¸Šå›ã£ã¦ã„ã¾ã™ã€‚ãƒãƒ¼ã‚¸ã‚’æ¨å¥¨ã—ã¾ã™ã€‚'
              ])
          elif quality_score >= 80:
              comment_parts.extend([
                  '',
                  '### âœ¨ è‰¯ã„ç‚¹',
                  '- é©åˆ‡ãªã‚³ãƒ¼ãƒ‰å“è³ªã‚’ç¶­æŒã—ã¦ã„ã¾ã™',
                  '- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™å€¤ã‚’æº€ãŸã—ã¦ã„ã¾ã™',
                  '- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã«æº–æ‹ ã—ã¦ã„ã¾ã™',
                  '',
                  '### ğŸ’¡ æ”¹å–„ææ¡ˆ',
                  '- ã‚ˆã‚Šè©³ç´°ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã¨ä¿å®ˆæ€§ãŒå‘ä¸Šã—ã¾ã™',
                  '- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ æ¤œè¨ã—ã¦ãã ã•ã„',
                  '',
                  '### ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',
                  'ã“ã®PRã¯å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚'
              ])
          elif quality_score >= 70:
              comment_parts.extend([
                  '',
                  '### âš ï¸ æ”¹å–„ãŒå¿…è¦ãªé …ç›®',
                  '- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸ŠãŒå¿…è¦ã§ã™ï¼ˆç›®æ¨™: 80%ä»¥ä¸Šï¼‰',
                  '- é™çš„è§£æã§æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã®ä¿®æ­£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„',
                  '- ã‚³ãƒ¼ãƒ‰ã®è¤‡é›‘åº¦ã‚’ä¸‹ã’ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™',
                  '',
                  '### ğŸ”§ æ¨å¥¨ä¿®æ­£',
                  '1. ä¸è¶³ã—ã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ',
                  '2. Lintã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£',
                  '3. é–¢æ•°ã®åˆ†å‰²ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç°¡ç´ åŒ–',
                  '',
                  '### ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
                  '- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š',
                  '- [ ] é™çš„è§£æã‚¨ãƒ©ãƒ¼0ä»¶',
                  '- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œä¿®æ­£'
              ])
          else:
              comment_parts.extend([
                  '',
                  '### ğŸš¨ å¿…é ˆä¿®æ­£é …ç›®',
                  '- **é‡è¦**: å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“',
                  '- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä¸ååˆ†ã§ã™',
                  '- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™',
                  '- ã‚³ãƒ¼ãƒ‰å“è³ªã®å¤§å¹…ãªæ”¹å–„ãŒå¿…è¦ã§ã™',
                  '',
                  '### ğŸ”§ å¿…é ˆä¿®æ­£',
                  '1. **ãƒ†ã‚¹ãƒˆè¿½åŠ **: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’80%ä»¥ä¸Šã«å‘ä¸Š',
                  '2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£**: æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ã®ä¿®æ­£',
                  '3. **ã‚³ãƒ¼ãƒ‰æ”¹å–„**: é™çš„è§£æã‚¨ãƒ©ãƒ¼ã®è§£æ±º',
                  '',
                  '### â›” ãƒãƒ¼ã‚¸æ¡ä»¶',
                  'ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã™ã¾ã§ãƒãƒ¼ã‚¸ã‚’æ§ãˆã¦ãã ã•ã„ï¼š',
                  '- [ ] å“è³ªã‚¹ã‚³ã‚¢80ç‚¹ä»¥ä¸Š',
                  '- [ ] å…¨ã¦ã®å¿…é ˆä¿®æ­£é …ç›®å®Œäº†',
                  '- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹'
              ])
          
          comment_parts.extend([
              '',
              '### ğŸ“Š è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ',
              f'- **å®Ÿè¡Œæ™‚åˆ»**: {os.getenv(\"GITHUB_RUN_ID\", \"N/A\")}',
              f'- **ãƒ–ãƒ©ãƒ³ãƒ**: {os.getenv(\"GITHUB_HEAD_REF\", \"N/A\")}',
              f'- **ã‚³ãƒŸãƒƒãƒˆ**: {os.getenv(\"GITHUB_SHA\", \"N/A\")[:8]}',
              '',
              '---',
              '*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ AI ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ãªåˆ†æçµæœã¯ Actions ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™ã€‚*'
          ])
          
          comment = '\n'.join(comment_parts)
          
          with open('review-comment.md', 'w', encoding='utf-8') as f:
              f.write(comment)
          
          print('Review comment generated successfully')
          "
          
      - name: ğŸ’¬ Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('review-comment.md', 'utf8');
            
            // æ—¢å­˜ã®AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            for (const existingComment of comments.data) {
              if (existingComment.body.includes('AI Code Review')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                });
              }
            }
            
            // æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
      - name: ğŸ“¤ Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            flake8-report.txt
            mypy-report/
            bandit-report.json
            safety-report.json
            coverage.json
            htmlcov/
            pytest-report.xml
            
      - name: ğŸ¯ Set Status Check
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const qualityScore = parseInt('${{ steps.quality-score.outputs.quality_score }}');
            
            let state, description;
            if (qualityScore >= 80) {
              state = 'success';
              description = `å“è³ªã‚¹ã‚³ã‚¢: ${qualityScore}/100 - ãƒãƒ¼ã‚¸å¯èƒ½`;
            } else {
              state = 'failure';
              description = `å“è³ªã‚¹ã‚³ã‚¢: ${qualityScore}/100 - æ”¹å–„ãŒå¿…è¦`;
            }
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'AI Code Review'
            });
</rewritten_file> 