name: Document Quality Check

on:
  pull_request:
    branches: [ main, develop ]
    paths: [ '**.md', 'docs/**' ]
  push:
    branches: [ main, develop ]
    paths: [ '**.md', 'docs/**' ]

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli
        
      - name: Run Markdown Lint
        run: markdownlint "**/*.md" --config .markdownlint.json

  link-check:
    name: Link Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Check Links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.markdown-link-check.json'

  format-validation:
    name: Document Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: Install Dependencies
        run: |
          pip install pyyaml python-frontmatter
          
      - name: Validate Work Reports
        run: |
          python scripts/validate_documents.py --type work_report --files "WORK_REPORT_*.md"
          
      - name: Validate Trouble Cases
        run: |
          python scripts/validate_documents.py --type trouble_cases --files "TROUBLE_CASES_*.md"
          
      - name: Check PROJECT_RULES Structure
        run: |
          python scripts/validate_documents.py --type project_rules --files "PROJECT_RULES.md"

  terminology-check:
    name: Terminology Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install textlint
        run: |
          npm install -g textlint
          npm install -g textlint-rule-preset-ja-technical-writing
          npm install -g textlint-rule-terminology
          
      - name: Run Terminology Check
        run: textlint "**/*.md" --config .textlintrc.json

  documentation-metrics:
    name: Documentation Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å±¥æ­´å…¨å–å¾—
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: Calculate Documentation Metrics
        run: |
          python scripts/doc_metrics.py --output metrics.json
          
      - name: Upload Metrics
        uses: actions/upload-artifact@v3
        with:
          name: documentation-metrics
          path: metrics.json
          
      - name: Comment PR with Metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const metrics = JSON.parse(fs.readFileSync('metrics.json', 'utf8'));
            
            const comment = `## ğŸ“Š æ–‡æ›¸å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
            
            | é …ç›® | å€¤ | åŸºæº– | çŠ¶æ…‹ |
            |------|-----|------|------|
            | æ–‡æ›¸ã‚«ãƒãƒ¬ãƒƒã‚¸ | ${metrics.coverage}% | 95% | ${metrics.coverage >= 95 ? 'âœ…' : 'âŒ'} |
            | ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæº–æ‹ ç‡ | ${metrics.format_compliance}% | 95% | ${metrics.format_compliance >= 95 ? 'âœ…' : 'âŒ'} |
            | ç”¨èªçµ±ä¸€æ€§ | ${metrics.terminology}% | 98% | ${metrics.terminology >= 98 ? 'âœ…' : 'âŒ'} |
            | ãƒªãƒ³ã‚¯æœ‰åŠ¹æ€§ | ${metrics.link_validity}% | 100% | ${metrics.link_validity >= 100 ? 'âœ…' : 'âŒ'} |
            
            ### ğŸ“ˆ è©³ç´°åˆ†æ
            - ç·æ–‡æ›¸æ•°: ${metrics.total_documents}
            - æ›´æ–°ã•ã‚ŒãŸæ–‡æ›¸: ${metrics.updated_documents}
            - æ–°è¦è¿½åŠ æ–‡æ›¸: ${metrics.new_documents}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  plantuml-check:
    name: PlantUML Syntax Check
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '.puml') || contains(github.event.pull_request.title, 'plantuml')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          
      - name: Download PlantUML
        run: |
          wget https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar
          
      - name: Check PlantUML Syntax
        run: |
          find docs/plantuml -name "*.puml" -exec java -jar plantuml.jar -checkonly {} \;

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [markdown-lint, link-check, format-validation, terminology-check]
    if: always()
    steps:
      - name: Check Quality Gate
        run: |
          if [[ "${{ needs.markdown-lint.result }}" == "success" && \
                "${{ needs.link-check.result }}" == "success" && \
                "${{ needs.format-validation.result }}" == "success" && \
                "${{ needs.terminology-check.result }}" == "success" ]]; then
            echo "âœ… å“è³ªã‚²ãƒ¼ãƒˆé€šé: å…¨ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            exit 0
          else
            echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—: ä¿®æ­£ãŒå¿…è¦ã§ã™"
            echo "Markdown Lint: ${{ needs.markdown-lint.result }}"
            echo "Link Check: ${{ needs.link-check.result }}"
            echo "Format Validation: ${{ needs.format-validation.result }}"
            echo "Terminology Check: ${{ needs.terminology-check.result }}"
            exit 1
          fi
          
      - name: Comment Quality Gate Result
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const results = {
              'markdown-lint': '${{ needs.markdown-lint.result }}',
              'link-check': '${{ needs.link-check.result }}',
              'format-validation': '${{ needs.format-validation.result }}',
              'terminology-check': '${{ needs.terminology-check.result }}'
            };
            
            const allPassed = Object.values(results).every(result => result === 'success');
            const emoji = allPassed ? 'âœ…' : 'âŒ';
            const status = allPassed ? 'é€šé' : 'å¤±æ•—';
            
            let comment = `## ${emoji} å“è³ªã‚²ãƒ¼ãƒˆçµæœ: ${status}\n\n`;
            comment += '| ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |\n';
            comment += '|-------------|------|\n';
            
            for (const [check, result] of Object.entries(results)) {
              const checkEmoji = result === 'success' ? 'âœ…' : 'âŒ';
              comment += `| ${check} | ${checkEmoji} ${result} |\n`;
            }
            
            if (!allPassed) {
              comment += '\nâš ï¸ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã¯Actionãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }); 